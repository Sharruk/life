{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Payment Checkout</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="payment-form">
                        {{ form.hidden_tag() }}

                        <!-- Address Section -->
                        <div class="mb-4">
                            <h6 class="mb-3">Delivery Address</h6>
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input" id="use-profile-address" checked>
                                <label class="form-check-label" for="use-profile-address">Use my profile address</label>
                            </div>
                            <textarea class="form-control" name="delivery_address" rows="2" readonly>{{ current_user.address }}</textarea>
                        </div>

                        <!-- Payment Methods -->
                        <div class="mb-4">
                            <h6 class="mb-3">Select Payment Method</h6>

                            <!-- Card Payment -->
                            <div class="form-check mb-3">
                                <input type="radio" class="form-check-input" name="payment_method" id="card" value="card">
                                <label class="form-check-label" for="card">
                                    <i class="fas fa-credit-card me-2"></i> Credit/Debit Card
                                </label>
                                <div id="card-details" class="payment-details mt-2 ms-4 d-none">
                                    <div class="mb-3">
                                        <input type="text" class="form-control" placeholder="Card Number">
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="text" class="form-control" placeholder="MM/YY">
                                        </div>
                                        <div class="col-6">
                                            <input type="text" class="form-control" placeholder="CVV">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- UPI Payment -->
                            <div class="form-check mb-3">
                                <input type="radio" class="form-check-input" name="payment_method" id="upi" value="upi">
                                <label class="form-check-label" for="upi">
                                    <i class="fas fa-mobile-alt me-2"></i> UPI Payment
                                </label>
                                <div id="upi-details" class="payment-details mt-2 ms-4 d-none">
                                    <div class="mb-3">
                                        <div class="alert alert-info">
                                            Please pay ₹{{ total }} to <strong>{{ restaurant.name.lower().replace(' ', '') }}@upi</strong>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Select UPI App</label>
                                            <div class="d-flex gap-3">
                                                <div class="form-check">
                                                    <input type="radio" class="form-check-input" name="upi_app" value="gpay">
                                                    <label class="form-check-label">Google Pay</label>
                                                </div>
                                                <div class="form-check">
                                                    <input type="radio" class="form-check-input" name="upi_app" value="phonepe">
                                                    <label class="form-check-label">PhonePe</label>
                                                </div>
                                                <div class="form-check">
                                                    <input type="radio" class="form-check-input" name="upi_app" value="bhim">
                                                    <label class="form-check-label">BHIM UPI</label>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="text" class="form-control" name="transaction_id" placeholder="Enter UPI Transaction ID">
                                        <div class="form-text">Transaction ID must be at least 12 characters</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Digital Wallet -->
                            <div class="form-check mb-3">
                                <input type="radio" class="form-check-input" name="payment_method" id="wallet" value="wallet">
                                <label class="form-check-label" for="wallet">
                                    <i class="fas fa-wallet me-2"></i> Digital Wallet
                                </label>
                                <div id="wallet-details" class="payment-details mt-2 ms-4 d-none">
                                    <div class="mb-3">
                                        <label class="form-label">Select Wallet</label>
                                        <select class="form-select mb-3" name="wallet_type">
                                            <option value="paytm">Paytm</option>
                                            <option value="amazonpay">Amazon Pay</option>
                                            <option value="phonepe">PhonePe</option>
                                        </select>
                                        <div class="alert alert-info">
                                            Send ₹{{ total }} to wallet ID: <strong>{{ restaurant.name.lower().replace(' ', '') }}-pay123</strong>
                                        </div>
                                        <input type="text" class="form-control" name="transaction_id" placeholder="Enter Wallet Transaction ID">
                                        <div class="form-text">Transaction ID must be at least 12 characters</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cash on Delivery -->
                            <div class="form-check mb-3">
                                <input type="radio" class="form-check-input" name="payment_method" id="cod" value="cod" checked>
                                <label class="form-check-label" for="cod">
                                    <i class="fas fa-money-bill me-2"></i> Cash on Delivery
                                </label>
                                <div id="cod-details" class="payment-details mt-2 ms-4">
                                    <div class="alert alert-info">
                                        Pay ₹{{ total }} with cash when your food is delivered
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            Place Order
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    {% for item in cart_items %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>{{ item.quantity }}x {{ item.name }}</span>
                        <span>₹{{ item.price * item.quantity }}</span>
                    </div>
                    {% endfor %}
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal</span>
                        <span>₹{{ subtotal }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Delivery Fee</span>
                        <span>₹{{ delivery_fee }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax</span>
                        <span>₹{{ tax }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total</span>
                        <span>₹{{ total }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show/hide payment details based on selection
    const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
    const paymentDetails = document.querySelectorAll('.payment-details');

    paymentMethods.forEach(method => {
        method.addEventListener('change', function() {
            paymentDetails.forEach(detail => detail.classList.add('d-none'));
            const selectedDetails = document.getElementById(`${this.value}-details`);
            if (selectedDetails) {
                selectedDetails.classList.remove('d-none');
            }
        });
    });

    // Form validation
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', function(e) {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked');

        if (selectedMethod.value === 'upi' || selectedMethod.value === 'wallet') {
            const transactionId = this.querySelector('input[name="transaction_id"]').value;
            if (transactionId.length < 12 || !transactionId.match(/^[a-zA-Z0-9]+$/)) {
                e.preventDefault();
                alert('Please enter a valid transaction ID (at least 12 alphanumeric characters)');
            }
        }
    });
});
</script>
{% endblock %}